import{at as c,aq as f,au as o,av as C,u as l,A as m,aw as a,ax as g,ay as p,az as S}from"./inspector-CyOA7R9n.js";import{f as u}from"./ScriptFormatter-CdcZyJ9a.js";class I extends f{uiSourceCodeDiffs;loadingUISourceCodes;modifiedUISourceCodesInternal;constructor(e){super(),this.uiSourceCodeDiffs=new WeakMap,this.loadingUISourceCodes=new Map,this.modifiedUISourceCodesInternal=new Set,e.addEventListener(o.WorkingCopyChanged,this.uiSourceCodeChanged,this),e.addEventListener(o.WorkingCopyCommitted,this.uiSourceCodeChanged,this),e.addEventListener(o.UISourceCodeAdded,this.uiSourceCodeAdded,this),e.addEventListener(o.UISourceCodeRemoved,this.uiSourceCodeRemoved,this),e.addEventListener(o.ProjectRemoved,this.projectRemoved,this),e.uiSourceCodes().forEach(this.updateModifiedState.bind(this))}requestDiff(e,t){return this.uiSourceCodeDiff(e).requestDiff(t)}subscribeToDiffChange(e,t,i){this.uiSourceCodeDiff(e).addEventListener("DiffChanged",t,i)}unsubscribeFromDiffChange(e,t,i){this.uiSourceCodeDiff(e).removeEventListener("DiffChanged",t,i)}modifiedUISourceCodes(){return Array.from(this.modifiedUISourceCodesInternal)}isUISourceCodeModified(e){return this.modifiedUISourceCodesInternal.has(e)||this.loadingUISourceCodes.has(e)}uiSourceCodeDiff(e){let t=this.uiSourceCodeDiffs.get(e);return t||(t=new D(e),this.uiSourceCodeDiffs.set(e,t)),t}uiSourceCodeChanged(e){const t=e.data.uiSourceCode;this.updateModifiedState(t)}uiSourceCodeAdded(e){const t=e.data;this.updateModifiedState(t)}uiSourceCodeRemoved(e){const t=e.data;this.removeUISourceCode(t)}projectRemoved(e){const t=e.data;for(const i of t.uiSourceCodes())this.removeUISourceCode(i)}removeUISourceCode(e){this.loadingUISourceCodes.delete(e);const t=this.uiSourceCodeDiffs.get(e);t&&(t.dispose=!0),this.markAsUnmodified(e)}markAsUnmodified(e){this.uiSourceCodeProcessedForTest(),this.modifiedUISourceCodesInternal.delete(e)&&this.dispatchEventToListeners("ModifiedStatusChanged",{uiSourceCode:e,isModified:!1})}markAsModified(e){this.uiSourceCodeProcessedForTest(),!this.modifiedUISourceCodesInternal.has(e)&&(this.modifiedUISourceCodesInternal.add(e),this.dispatchEventToListeners("ModifiedStatusChanged",{uiSourceCode:e,isModified:!0}))}uiSourceCodeProcessedForTest(){}async updateModifiedState(e){if(this.loadingUISourceCodes.delete(e),e.project().type()!==C.Network){this.markAsUnmodified(e);return}if(e.isDirty()){this.markAsModified(e);return}if(!e.hasCommits()){this.markAsUnmodified(e);return}const t=Promise.all([this.requestOriginalContentForUISourceCode(e),e.requestContent().then(s=>s.content)]);this.loadingUISourceCodes.set(e,t);const i=await t;this.loadingUISourceCodes.get(e)===t&&(this.loadingUISourceCodes.delete(e),i[0]!==null&&i[1]!==null&&i[0]!==i[1]?this.markAsModified(e):this.markAsUnmodified(e))}requestOriginalContentForUISourceCode(e){return this.uiSourceCodeDiff(e).originalContent()}revertToOriginal(e){function t(i){typeof i=="string"&&e.addRevision(i)}return l.actionTaken(m.RevisionApplied),this.requestOriginalContentForUISourceCode(e).then(t)}}class D extends f{uiSourceCode;requestDiffPromise;pendingChanges;dispose;constructor(e){super(),this.uiSourceCode=e,e.addEventListener(a.WorkingCopyChanged,this.uiSourceCodeChanged,this),e.addEventListener(a.WorkingCopyCommitted,this.uiSourceCodeChanged,this),this.requestDiffPromise=null,this.pendingChanges=null,this.dispose=!1}uiSourceCodeChanged(){this.pendingChanges&&(clearTimeout(this.pendingChanges),this.pendingChanges=null),this.requestDiffPromise=null;const e=this.uiSourceCode.content(),t=!e||e.length<65536?0:U;this.pendingChanges=window.setTimeout(i.bind(this),t);function i(){this.dispose||(this.dispatchEventToListeners("DiffChanged"),this.pendingChanges=null)}}requestDiff(e){return this.requestDiffPromise||(this.requestDiffPromise=this.innerRequestDiff(e)),this.requestDiffPromise}async originalContent(){const e=g.instance().originalContentForUISourceCode(this.uiSourceCode);if(e)return e;const t=await this.uiSourceCode.project().requestFileContent(this.uiSourceCode);return p.isError(t)?t.error:t.asDeferedContent().content}async innerRequestDiff({shouldFormatDiff:e}){if(this.dispose)return null;let t=await this.originalContent();if(t===null||t.length>1024*1024||this.dispose)return null;let i=this.uiSourceCode.workingCopy();if(!i&&!this.uiSourceCode.contentLoaded()&&(i=(await this.uiSourceCode.requestContent()).content),i.length>1024*1024||this.dispose||i===null||t===null)return null;let s;if(e){t=(await u(this.uiSourceCode.contentType(),this.uiSourceCode.mimeType(),t)).formattedContent;const d=await u(this.uiSourceCode.contentType(),this.uiSourceCode.mimeType(),i);i=d.formattedContent,s=d.formattedMapping}const r=/\r\n?|\n/;return{diff:S.lineDiff(t.split(r),i.split(r)),formattedCurrentMapping:s}}}let n=null;function q(){return n||(n=new I(c.instance())),n}const U=200;export{q as w};
//# sourceMappingURL=WorkspaceDiff-_8IW6Oi2.js.map
