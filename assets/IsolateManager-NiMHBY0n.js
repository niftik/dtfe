import{aq as d,i as u,ar as c}from"./inspector-CyOA7R9n.js";let o;class r extends d{#s;#e;#t;#i;constructor(){super(),this.#s=new Map,this.#e=new Map,this.#t=new Set,u.instance().observeModels(c,this),this.#i=0}static instance({forceNew:t}={forceNew:!1}){return(!o||t)&&(o=new r),o}observeIsolates(t){if(this.#t.has(t))throw new Error("Observer can only be registered once");this.#t.size||this.poll(),this.#t.add(t);for(const e of this.#s.values())t.isolateAdded(e)}unobserveIsolates(t){this.#t.delete(t),this.#t.size||++this.#i}modelAdded(t){this.modelAddedInternal(t)}async modelAddedInternal(t){this.#e.set(t,null);const e=await t.isolateId();if(!this.#e.has(t))return;if(!e){this.#e.delete(t);return}this.#e.set(t,e);let s=this.#s.get(e);if(s||(s=new m(e),this.#s.set(e,s)),s.modelsInternal.add(t),s.modelsInternal.size===1)for(const i of this.#t)i.isolateAdded(s);else for(const i of this.#t)i.isolateChanged(s)}modelRemoved(t){const e=this.#e.get(t);if(this.#e.delete(t),!e)return;const s=this.#s.get(e);if(s){if(s.modelsInternal.delete(t),s.modelsInternal.size){for(const i of this.#t)i.isolateChanged(s);return}for(const i of this.#t)i.isolateRemoved(s);this.#s.delete(e)}}isolateByModel(t){return this.#s.get(this.#e.get(t)||"")||null}isolates(){return this.#s.values()}async poll(){const t=this.#i;for(;t===this.#i;)await Promise.all(Array.from(this.isolates(),e=>e.update())),await new Promise(e=>window.setTimeout(e,a))}}const f=12e4,a=2e3;class m{#s;modelsInternal;#e;#t;constructor(t){this.#s=t,this.modelsInternal=new Set,this.#e=0;const e=f/a;this.#t=new I(e)}id(){return this.#s}models(){return this.modelsInternal}runtimeModel(){return this.modelsInternal.values().next().value||null}heapProfilerModel(){const t=this.runtimeModel();return t&&t.heapProfilerModel()}async update(){const t=this.runtimeModel(),e=t&&await t.heapUsage();e&&(this.#e=e.usedSize,this.#t.add(this.#e),r.instance().dispatchEventToListeners("MemoryChanged",this))}samplesCount(){return this.#t.count()}usedHeapSize(){return this.#e}usedHeapSizeGrowRate(){return this.#t.fitSlope()}}class I{#s;#e;#t;#i;#a;#n;#o;#r;#h;constructor(t){this.#s=t|0,this.reset()}reset(){this.#e=Date.now(),this.#t=0,this.#i=[],this.#a=[],this.#n=0,this.#o=0,this.#r=0,this.#h=0}count(){return this.#i.length}add(t,e){const s=typeof e=="number"?e:Date.now()-this.#e,i=t;if(this.#i.length===this.#s){const n=this.#i[this.#t],h=this.#a[this.#t];this.#n-=n,this.#o-=h,this.#r-=n*n,this.#h-=n*h}this.#n+=s,this.#o+=i,this.#r+=s*s,this.#h+=s*i,this.#i[this.#t]=s,this.#a[this.#t]=i,this.#t=(this.#t+1)%this.#s}fitSlope(){const t=this.count();return t<2?0:(this.#h-this.#n*this.#o/t)/(this.#r-this.#n*this.#n/t)}}export{r as I,f as M};
//# sourceMappingURL=IsolateManager-NiMHBY0n.js.map
