import{bm as Te,b as H,g as A,aj as W,as as Ie,d_ as Ee,ba as Y,cC as Re,bi as pe,cD as Be,bS as k,bM as ee,bx as Me,da as ke,em as He,c3 as me,bq as Z,cc as ge,c7 as J,aq as Ae,cP as De,bA as Oe,bz as Fe,ct as te,bN as We,en as Ve,bv as I,aU as se,eo as Ne,ep as q,eq as Xe,bQ as Ue,bD as je,d2 as Ye,h as _e,ch as ze,cg as ie,cS as ne,er as _,es as $e,bo as Ge,et as qe,dV as Ke,c$ as Qe}from"./inspector-CyOA7R9n.js";import{d as Ze,W as Je}from"./timelineOverviewInfo.css-BT4HnMd6.js";import"./PreviewFactory-7rWtg079.js";class Pt{#i;#e;#t;#s;constructor(e,t){this.#i=t.stickyBoxRect,this.#e=t.containingBlockRect,this.#t=null,e&&t.nearestLayerShiftingStickyBox&&(this.#t=e.layerById(t.nearestLayerShiftingStickyBox)),this.#s=null,e&&t.nearestLayerShiftingContainingBlock&&(this.#s=e.layerById(t.nearestLayerShiftingContainingBlock))}stickyBoxRect(){return this.#i}containingBlockRect(){return this.#e}nearestLayerShiftingStickyBox(){return this.#t}nearestLayerShiftingContainingBlock(){return this.#s}}class Lt{#i;#e;layersById;#t;#s;#n;#r;constructor(e){this.#i=e,this.#e=e?e.model(Te):null,this.layersById=new Map,this.#t=null,this.#s=null,this.#n=new Map}target(){return this.#i}root(){return this.#t}setRoot(e){this.#t=e}contentRoot(){return this.#s}setContentRoot(e){this.#s=e}forEachLayer(e,t){return!t&&(t=this.root(),!t)?!1:e(t)||t.children().some(this.forEachLayer.bind(this,e))}layerById(e){return this.layersById.get(e)||null}async resolveBackendNodeIds(e){if(!e.size||!this.#e)return;const t=await this.#e.pushNodesByBackendIdsToFrontend(e);if(t)for(const s of t.keys())this.#n.set(s,t.get(s)||null)}backendNodeIdToNode(){return this.#n}setViewportSize(e){this.#r=e}viewportSize(){return this.#r}nodeForId(e){return this.#e?this.#e.nodeForId(e):null}}const fe=new CSSStyleSheet;fe.replaceSync(`/*
 * Copyright 2016 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file.
 */

table td {
  padding-left: 8px;
}

table td:first-child {
  font-weight: bold;
}

.scroll-rect.active {
  background-color: var(--sys-color-neutral-container);
}

ul {
  list-style: none;
  padding-inline-start: 0;
  margin-block-start: 0;
  margin-block-end: 0;
}

.devtools-link.link-margin {
  margin: 8px;
  display: inline-block;
}

/*# sourceURL=layerDetailsView.css */
`);const ye={showInternalLayers:"Show internal layers"},et=H("panels/layer_viewer/LayerViewHost.ts",ye),tt=A.bind(void 0,et);class E{typeInternal;layerInternal;constructor(e,t){this.typeInternal=e,this.layerInternal=t}static isEqual(e,t){return e&&t?e.isEqual(t):e===t}type(){return this.typeInternal}layer(){return this.layerInternal}isEqual(e){return!1}}class K extends E{constructor(e){console.assert(!!e,"LayerSelection with empty layer"),super("Layer",e)}isEqual(e){return e.typeInternal==="Layer"&&e.layer().id()===this.layer().id()}}class we extends E{scrollRectIndex;constructor(e,t){super("ScrollRect",e),this.scrollRectIndex=t}isEqual(e){return e.typeInternal==="ScrollRect"&&this.layer().id()===e.layer().id()&&this.scrollRectIndex===e.scrollRectIndex}}class st extends E{snapshotInternal;constructor(e,t){super("Snapshot",e),this.snapshotInternal=t}isEqual(e){return e.typeInternal==="Snapshot"&&this.layer().id()===e.layer().id()&&this.snapshotInternal===e.snapshotInternal}snapshot(){return this.snapshotInternal}}class Tt{views;selectedObject;hoveredObject;showInternalLayersSettingInternal;snapshotLayers;target;constructor(){this.views=[],this.selectedObject=null,this.hoveredObject=null,this.showInternalLayersSettingInternal=W.instance().createSetting("layers-show-internal-layers",!1),this.snapshotLayers=new Map}registerView(e){this.views.push(e)}setLayerSnapshotMap(e){this.snapshotLayers=e}getLayerSnapshotMap(){return this.snapshotLayers}setLayerTree(e){if(!e)return;this.target=e.target();const t=this.selectedObject&&this.selectedObject.layer();t&&(!e||!e.layerById(t.id()))&&this.selectObject(null);const s=this.hoveredObject&&this.hoveredObject.layer();s&&(!e||!e.layerById(s.id()))&&this.hoverObject(null);for(const i of this.views)i.setLayerTree(e)}hoverObject(e){if(E.isEqual(this.hoveredObject,e))return;this.hoveredObject=e;const t=e&&e.layer();this.toggleNodeHighlight(t?t.nodeForSelfOrAncestor():null);for(const s of this.views)s.hoverObject(e)}selectObject(e){if(!E.isEqual(this.selectedObject,e)){this.selectedObject=e;for(const t of this.views)t.selectObject(e)}}selection(){return this.selectedObject}showContextMenu(e,t){e.defaultSection().appendCheckboxItem(tt(ye.showInternalLayers),this.toggleShowInternalLayers.bind(this),{checked:this.showInternalLayersSettingInternal.get(),jslogContext:this.showInternalLayersSettingInternal.name});const s=t&&t.layer()&&t.layer().nodeForSelfOrAncestor();s&&e.appendApplicableItems(s),e.show()}showInternalLayersSetting(){return this.showInternalLayersSettingInternal}toggleShowInternalLayers(){this.showInternalLayersSettingInternal.set(!this.showInternalLayersSettingInternal.get())}toggleNodeHighlight(e){if(e){e.highlightForTwoSeconds();return}Ie.hideDOMNodeHighlight()}}const c={selectALayerToSeeItsDetails:"Select a layer to see its details",scrollRectangleDimensions:"{PH1} {PH2} × {PH3} (at {PH4}, {PH5})",unnamed:"<unnamed>",stickyAncenstorLayersS:"{PH1}: {PH2} ({PH3})",stickyBoxRectangleDimensions:"Sticky Box {PH1} × {PH2} (at {PH3}, {PH4})",containingBlocRectangleDimensions:"Containing Block {PH1} × {PH2} (at {PH3}, {PH4})",nearestLayerShiftingStickyBox:"Nearest Layer Shifting Sticky Box",nearestLayerShiftingContaining:"Nearest Layer Shifting Containing Block",updateRectangleDimensions:"{PH1} × {PH2} (at {PH3}, {PH4})",size:"Size",compositingReasons:"Compositing Reasons",memoryEstimate:"Memory estimate",paintCount:"Paint count",slowScrollRegions:"Slow scroll regions",stickyPositionConstraint:"Sticky position constraint",paintProfiler:"Paint Profiler",nonFastScrollable:"Non fast scrollable",touchEventHandler:"Touch event handler",wheelEventHandler:"Wheel event handler",repaintsOnScroll:"Repaints on scroll",mainThreadScrollingReason:"Main thread scrolling reason"},Ce=H("panels/layer_viewer/LayerDetailsView.ts",c),f=A.bind(void 0,Ce),D=Ee.bind(void 0,Ce);class It extends Y(Re){layerViewHost;emptyWidget;layerSnapshotMap;tableElement;tbodyElement;sizeCell;compositingReasonsCell;memoryEstimateCell;paintCountCell;scrollRectsCell;stickyPositionConstraintCell;paintProfilerLink;selection;constructor(e){super(!0),this.element.setAttribute("jslog",`${pe("layers-details")}`),this.layerViewHost=e,this.layerViewHost.registerView(this),this.emptyWidget=new Be(f(c.selectALayerToSeeItsDetails)),this.layerSnapshotMap=this.layerViewHost.getLayerSnapshotMap(),this.buildContent(),this.selection=null}hoverObject(e){}selectObject(e){this.selection=e,this.isShowing()&&this.update()}setLayerTree(e){}wasShown(){super.wasShown(),this.registerCSSFiles([fe]),this.update()}onScrollRectClicked(e,t){t.which===1&&this.selection&&this.layerViewHost.selectObject(new we(this.selection.layer(),e))}invokeProfilerLink(){if(!this.selection)return;const e=this.selection.type()==="Snapshot"?this.selection:this.layerSnapshotMap.get(this.selection.layer());e&&this.dispatchEventToListeners("PaintProfilerRequested",e)}createScrollRectElement(e,t){t&&k(this.scrollRectsCell,", ");const s=this.scrollRectsCell.createChild("span","scroll-rect");this.selection&&this.selection.scrollRectIndex===t&&s.classList.add("active"),s.textContent=f(c.scrollRectangleDimensions,{PH1:String(it.get(e.type)?.()),PH2:e.rect.width,PH3:e.rect.height,PH4:e.rect.x,PH5:e.rect.y}),s.addEventListener("click",this.onScrollRectClicked.bind(this,t),!1),s.setAttribute("jslog",`${ee("layers.select-object").track({click:!0})}`)}formatStickyAncestorLayer(e,t){if(!t)return"";const s=t.nodeForSelfOrAncestor(),i=s?s.simpleSelector():f(c.unnamed);return f(c.stickyAncenstorLayersS,{PH1:e,PH2:i,PH3:t.id()})}createStickyAncestorChild(e,t){if(!t)return;k(this.stickyPositionConstraintCell,", ");const s=this.stickyPositionConstraintCell.createChild("span");s.textContent=this.formatStickyAncestorLayer(e,t)}populateStickyPositionConstraintCell(e){if(this.stickyPositionConstraintCell.removeChildren(),!e)return;const t=e.stickyBoxRect(),s=this.stickyPositionConstraintCell.createChild("span");s.textContent=f(c.stickyBoxRectangleDimensions,{PH1:t.width,PH2:t.height,PH3:t.x,PH4:t.y}),k(this.stickyPositionConstraintCell,", ");const i=e.containingBlockRect(),n=this.stickyPositionConstraintCell.createChild("span");n.textContent=f(c.containingBlocRectangleDimensions,{PH1:i.width,PH2:i.height,PH3:i.x,PH4:i.y}),this.createStickyAncestorChild(f(c.nearestLayerShiftingStickyBox),e.nearestLayerShiftingStickyBox()),this.createStickyAncestorChild(f(c.nearestLayerShiftingContaining),e.nearestLayerShiftingContainingBlock())}update(){const e=this.selection&&this.selection.layer();if(!e){this.tableElement.remove(),this.paintProfilerLink.remove(),this.emptyWidget.show(this.contentElement);return}this.emptyWidget.detach(),this.contentElement.appendChild(this.tableElement),this.contentElement.appendChild(this.paintProfilerLink),this.sizeCell.textContent=f(c.updateRectangleDimensions,{PH1:e.width(),PH2:e.height(),PH3:e.offsetX(),PH4:e.offsetY()}),this.paintCountCell.parentElement&&this.paintCountCell.parentElement.classList.toggle("hidden",!e.paintCount()),this.paintCountCell.textContent=String(e.paintCount()),this.memoryEstimateCell.textContent=Me(e.gpuMemoryUsage()),e.requestCompositingReasons().then(this.updateCompositingReasons.bind(this)),this.scrollRectsCell.removeChildren(),e.scrollRects().forEach(this.createScrollRectElement.bind(this)),this.populateStickyPositionConstraintCell(e.stickyPositionConstraint());const t=this.selection&&this.selection.type()==="Snapshot"?this.selection.snapshot():null;this.paintProfilerLink.classList.toggle("hidden",!(this.layerSnapshotMap.has(e)||t))}buildContent(){this.tableElement=this.contentElement.createChild("table"),this.tbodyElement=this.tableElement.createChild("tbody"),this.sizeCell=this.createRow(f(c.size)),this.compositingReasonsCell=this.createRow(f(c.compositingReasons)),this.memoryEstimateCell=this.createRow(f(c.memoryEstimate)),this.paintCountCell=this.createRow(f(c.paintCount)),this.scrollRectsCell=this.createRow(f(c.slowScrollRegions)),this.stickyPositionConstraintCell=this.createRow(f(c.stickyPositionConstraint)),this.paintProfilerLink=this.contentElement.createChild("button","hidden devtools-link link-margin text-button link-style"),ke(this.paintProfilerLink),this.paintProfilerLink.textContent=f(c.paintProfiler),this.paintProfilerLink.tabIndex=0,this.paintProfilerLink.addEventListener("click",e=>{e.consume(!0),this.invokeProfilerLink()}),this.paintProfilerLink.setAttribute("jslog",`${ee("layers.paint-profiler").track({click:!0,keydown:"Enter"})}`)}createRow(e){const t=this.tbodyElement.createChild("tr"),s=t.createChild("td");return s.textContent=e,t.createChild("td")}updateCompositingReasons(e){if(!e||!e.length){this.compositingReasonsCell.textContent="n/a";return}this.compositingReasonsCell.removeChildren();const t=this.compositingReasonsCell.createChild("ul");for(const s of e)t.createChild("li").textContent=s}}const it=new Map([["NonFastScrollable",D(c.nonFastScrollable)],["TouchEventHandler",D(c.touchEventHandler)],["WheelEventHandler",D(c.wheelEventHandler)],["RepaintsOnScroll",D(c.repaintsOnScroll)],["MainThreadScrollingReason",D(c.mainThreadScrollingReason)]]),U={layersTreePane:"Layers Tree Pane",showPaintProfiler:"Show Paint Profiler",updateChildDimension:" ({PH1} × {PH2})"},nt=H("panels/layer_viewer/LayerTreeOutline.ts",U),Q=A.bind(void 0,nt);class Et extends Y(He){layerViewHost;treeOutline;lastHoveredNode;element;layerTree;layerSnapshotMap;constructor(e){super(),this.layerViewHost=e,this.layerViewHost.registerView(this),this.treeOutline=new me,this.treeOutline.element.classList.add("layer-tree","overflow-auto"),this.treeOutline.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.treeOutline.element.addEventListener("mouseout",this.onMouseMove.bind(this),!1),this.treeOutline.element.addEventListener("contextmenu",this.onContextMenu.bind(this),!0),Z(this.treeOutline.contentElement,Q(U.layersTreePane)),this.lastHoveredNode=null,this.element=this.treeOutline.element,this.layerViewHost.showInternalLayersSetting().addChangeListener(this.update,this)}focus(){this.treeOutline.focus()}selectObject(e){this.hoverObject(null);const t=e&&e.layer(),s=t&&M.get(t);s?s.revealAndSelect(!0):this.treeOutline.selectedTreeElement&&this.treeOutline.selectedTreeElement.deselect()}hoverObject(e){const t=e&&e.layer(),s=t&&M.get(t);s!==this.lastHoveredNode&&(this.lastHoveredNode&&this.lastHoveredNode.setHovered(!1),s&&s.setHovered(!0),this.lastHoveredNode=s)}setLayerTree(e){this.layerTree=e,this.update()}update(){const e=this.layerViewHost.showInternalLayersSetting().get(),t=new Map;let s=null;this.layerTree&&(e||(s=this.layerTree.contentRoot()),s||(s=this.layerTree.root()));function i(r){if(!r.drawsContent()&&!e)return;t.get(r)&&console.assert(!1,"Duplicate layer: "+r.id()),t.set(r,!0);let o=M.get(r)||null,l=r.parent();for(;l&&l!==s&&!l.drawsContent()&&!e;)l=l.parent();const a=r===s?this.treeOutline.rootElement():l&&M.get(l);if(!a){console.assert(!1,"Parent is not in the tree");return}if(!o)o=new re(this,r),a.appendChild(o),r.drawsContent()||o.expand();else{if(o.parent!==a){const h=this.treeOutline.selectedTreeElement;o.parent&&o.parent.removeChild(o),a.appendChild(o),h&&h!==this.treeOutline.selectedTreeElement&&h.select()}o.update()}}s&&this.layerTree&&this.layerTree.forEachLayer(i.bind(this),s);const n=this.treeOutline.rootElement();for(let r=n.firstChild();r instanceof re&&!r.root;)if(t.get(r.layer))r=r.traverseNextTreeElement(!1);else{const o=r.nextSibling||r.parent;r.parent&&r.parent.removeChild(r),r===this.lastHoveredNode&&(this.lastHoveredNode=null),r=o}if(!this.treeOutline.selectedTreeElement&&this.layerTree){const r=this.layerTree.contentRoot()||this.layerTree.root();if(r){const o=M.get(r);o&&o.revealAndSelect(!0)}}}onMouseMove(e){const t=this.treeOutline.treeElementFromEvent(e);t!==this.lastHoveredNode&&this.layerViewHost.hoverObject(this.selectionForNode(t))}selectedNodeChanged(e){this.layerViewHost.selectObject(this.selectionForNode(e))}onContextMenu(e){const t=this.selectionForNode(this.treeOutline.treeElementFromEvent(e)),s=new ge(e),i=t&&t.layer();i&&(this.layerSnapshotMap=this.layerViewHost.getLayerSnapshotMap(),this.layerSnapshotMap.has(i)&&s.defaultSection().appendItem(Q(U.showPaintProfiler),()=>this.dispatchEventToListeners("PaintProfilerRequested",t),{jslogContext:"layers.paint-profiler"})),this.layerViewHost.showContextMenu(s,t)}selectionForNode(e){return e&&e.layer?new K(e.layer):null}}class re extends J{treeOutlineInternal;layer;constructor(e,t){super(),this.treeOutlineInternal=e,this.layer=t,M.set(t,this),this.update()}update(){const e=this.layer.nodeForSelfOrAncestor(),t=document.createDocumentFragment();k(t,e?e.simpleSelector():"#"+this.layer.id());const s=t.createChild("span","dimmed");s.textContent=Q(U.updateChildDimension,{PH1:this.layer.width(),PH2:this.layer.height()}),this.title=t}onselect(){return this.treeOutlineInternal.selectedNodeChanged(this),!1}setHovered(e){this.listItemElement.classList.toggle("hovered",e)}}const M=new WeakMap,Se=new CSSStyleSheet;Se.replaceSync(`/*
 * Copyright 2016 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file.
 */

.layers-3d-view {
  overflow: hidden;
  user-select: none;
}

.toolbar {
  background-color: var(--sys-color-cdt-base-container);
  border-bottom: 1px solid var(--sys-color-divider);
}

canvas {
  flex: 1 1;
}

.layers-3d-view > canvas:focus-visible {
  outline: auto 5px -webkit-focus-ring-color;
}

/*# sourceURL=layers3DView.css */
`);const V={panModeX:"Pan mode (X)",rotateModeV:"Rotate mode (V)",resetTransform:"Reset transform (0)"},rt=H("panels/layer_viewer/TransformController.ts",V),z=A.bind(void 0,rt);class ot extends Ae{mode;scaleInternal;offsetXInternal;offsetYInternal;rotateXInternal;rotateYInternal;oldRotateX;oldRotateY;originX;originY;element;minScale;maxScale;controlPanelToolbar;modeButtons;constructor(e,t){if(super(),this.scaleInternal=1,this.offsetXInternal=0,this.offsetYInternal=0,this.rotateXInternal=0,this.rotateYInternal=0,this.oldRotateX=0,this.oldRotateY=0,this.originX=0,this.originY=0,this.element=e,this.registerShortcuts(),De(e,this.onDragStart.bind(this),this.onDrag.bind(this),this.onDragEnd.bind(this),"move",null),e.addEventListener("wheel",this.onMouseWheel.bind(this),!1),this.minScale=0,this.maxScale=1/0,this.controlPanelToolbar=new Oe("transform-control-panel"),this.controlPanelToolbar.element.setAttribute("jslog",`${Fe()}`),this.modeButtons={},!t){const i=new te(z(V.panModeX),"3d-pan",void 0,"layers.3d-pan",!1);i.addEventListener("Click",this.setMode.bind(this,"Pan")),this.modeButtons.Pan=i,this.controlPanelToolbar.appendToolbarItem(i);const n=new te(z(V.rotateModeV),"3d-rotate",void 0,"layers.3d-rotate",!1);n.addEventListener("Click",this.setMode.bind(this,"Rotate")),this.modeButtons.Rotate=n,this.controlPanelToolbar.appendToolbarItem(n)}this.setMode("Pan");const s=new We(z(V.resetTransform),"3d-center",void 0,"layers.3d-center");s.addEventListener("Click",this.resetAndNotify.bind(this,void 0)),this.controlPanelToolbar.appendToolbarItem(s),this.reset()}toolbar(){return this.controlPanelToolbar}registerShortcuts(){Ve.instance().addShortcutListener(this.element,{"layers.reset-view":async()=>(this.resetAndNotify(),!0),"layers.pan-mode":async()=>(this.setMode("Pan"),!0),"layers.rotate-mode":async()=>(this.setMode("Rotate"),!0),"layers.zoom-in":this.onKeyboardZoom.bind(this,1.1),"layers.zoom-out":this.onKeyboardZoom.bind(this,1/1.1),"layers.up":this.onKeyboardPanOrRotate.bind(this,0,-1),"layers.down":this.onKeyboardPanOrRotate.bind(this,0,1),"layers.left":this.onKeyboardPanOrRotate.bind(this,-1,0),"layers.right":this.onKeyboardPanOrRotate.bind(this,1,0)})}postChangeEvent(){this.dispatchEventToListeners("TransformChanged")}reset(){this.scaleInternal=1,this.offsetXInternal=0,this.offsetYInternal=0,this.rotateXInternal=0,this.rotateYInternal=0}setMode(e){this.mode!==e&&(this.mode=e,this.updateModeButtons())}updateModeButtons(){for(const e in this.modeButtons)this.modeButtons[e].setToggled(e===this.mode)}resetAndNotify(e){this.reset(),this.postChangeEvent(),e&&e.preventDefault(),this.element.focus()}setScaleConstraints(e,t){this.minScale=e,this.maxScale=t,this.scaleInternal=I(this.scaleInternal,e,t)}clampOffsets(e,t,s,i){this.offsetXInternal=I(this.offsetXInternal,e,t),this.offsetYInternal=I(this.offsetYInternal,s,i)}scale(){return this.scaleInternal}offsetX(){return this.offsetXInternal}offsetY(){return this.offsetYInternal}rotateX(){return this.rotateXInternal}rotateY(){return this.rotateYInternal}onScale(e,t,s){e=I(this.scaleInternal*e,this.minScale,this.maxScale)/this.scaleInternal,this.scaleInternal*=e,this.offsetXInternal-=(t-this.offsetXInternal)*(e-1),this.offsetYInternal-=(s-this.offsetYInternal)*(e-1),this.postChangeEvent()}onPan(e,t){this.offsetXInternal+=e,this.offsetYInternal+=t,this.postChangeEvent()}onRotate(e,t){this.rotateXInternal=e,this.rotateYInternal=t,this.postChangeEvent()}async onKeyboardZoom(e){return this.onScale(e,this.element.clientWidth/2,this.element.clientHeight/2),!0}async onKeyboardPanOrRotate(e,t){return this.mode==="Rotate"?this.onRotate(this.rotateXInternal+t*5,this.rotateYInternal+e*5):this.onPan(e*6,t*6),!0}onMouseWheel(e){const s=.018867924528301886,i=e,n=Math.pow(1.1,-i.deltaY*s);this.onScale(n,i.clientX-this.element.getBoundingClientRect().left,i.clientY-this.element.getBoundingClientRect().top)}onDrag(e){const{clientX:t,clientY:s}=e;this.mode==="Rotate"?this.onRotate(this.oldRotateX+(this.originY-s)/this.element.clientHeight*180,this.oldRotateY-(this.originX-t)/this.element.clientWidth*180):(this.onPan(t-this.originX,s-this.originY),this.originX=t,this.originY=s)}onDragStart(e){return this.element.focus(),this.originX=e.clientX,this.originY=e.clientY,this.oldRotateX=this.rotateXInternal,this.oldRotateY=this.rotateYInternal,!0}onDragEnd(){this.originX=0,this.originY=0,this.oldRotateX=0,this.oldRotateY=0}}const w={layerInformationIsNotYet:"Layer information is not yet available.",dLayersView:"3D Layers View",cantDisplayLayers:"Can't display layers,",webglSupportIsDisabledInYour:"WebGL support is disabled in your browser.",checkSForPossibleReasons:"Check {PH1} for possible reasons.",slowScrollRects:"Slow scroll rects",paints:"Paints",resetView:"Reset View",showPaintProfiler:"Show Paint Profiler"},ve=H("panels/layer_viewer/Layers3DView.ts",w),v=A.bind(void 0,ve),oe=new Map,ae=new Map,le=new Map,he=new Map,ce=new Map,N=new Map;class Rt extends Y(se){failBanner;layerViewHost;transformController;canvasElement;lastSelection;layerTree;textureManager;chromeTextures;rects;snapshotLayers;shaderProgram;oldTextureScale;depthByLayerId;visibleLayers;maxDepth;scale;layerTexture;projectionMatrix;whiteTexture;gl;dimensionsForAutoscale;needsUpdate;updateScheduled;panelToolbar;showSlowScrollRectsSetting;showPaintsSetting;mouseDownX;mouseDownY;constructor(e){super(!0),this.element.setAttribute("jslog",`${pe("layers-3d-view")}`),this.contentElement.classList.add("layers-3d-view"),this.failBanner=new se,this.failBanner.element.classList.add("full-widget-dimmed-banner"),k(this.failBanner.element,v(w.layerInformationIsNotYet)),this.layerViewHost=e,this.layerViewHost.registerView(this),this.transformController=new ot(this.contentElement),this.transformController.addEventListener("TransformChanged",this.update,this),this.initToolbar(),this.canvasElement=this.contentElement.createChild("canvas"),this.canvasElement.tabIndex=0,this.canvasElement.addEventListener("dblclick",this.onDoubleClick.bind(this),!1),this.canvasElement.addEventListener("mousedown",this.onMouseDown.bind(this),!1),this.canvasElement.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this.canvasElement.addEventListener("mouseleave",this.onMouseMove.bind(this),!1),this.canvasElement.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.canvasElement.addEventListener("contextmenu",this.onContextMenu.bind(this),!1),this.canvasElement.setAttribute("jslog",`${Ne("layers").track({click:!0,drag:!0})}`),Z(this.canvasElement,v(w.dLayersView)),this.lastSelection={},this.layerTree=null,this.updateScheduled=!1,this.textureManager=new X(this.update.bind(this)),this.chromeTextures=[],this.rects=[],this.snapshotLayers=new Map,this.layerViewHost.setLayerSnapshotMap(this.snapshotLayers),this.layerViewHost.showInternalLayersSetting().addChangeListener(this.update,this)}setLayerTree(e){this.layerTree=e,this.layerTexture=null,delete this.oldTextureScale,this.showPaints()&&this.textureManager.setLayerTree(e),this.update()}showImageForLayer(e,t){if(!t){this.layerTexture=null,this.update();return}q(t).then(s=>{const i=s&&X.createTextureForImage(this.gl||null,s);this.layerTexture=i?{layer:e,texture:i}:null,this.update()})}onResize(){this.resizeCanvas(),this.update()}willHide(){this.textureManager.suspend()}wasShown(){this.textureManager.resume(),this.registerCSSFiles([Se]),this.needsUpdate&&(this.resizeCanvas(),this.update())}updateLayerSnapshot(e){this.textureManager.layerNeedsUpdate(e)}setOutline(e,t){this.lastSelection[e]=t,this.update()}hoverObject(e){this.setOutline(T.Hovered,e)}selectObject(e){this.setOutline(T.Hovered,null),this.setOutline(T.Selected,e)}snapshotForSelection(e){if(e.type()==="Snapshot"){const t=e.snapshot();return t.snapshot.addReference(),Promise.resolve(t)}if(e.layer()){const t=e.layer().snapshots()[0];if(t!==void 0)return t}return Promise.resolve(null)}initGL(e){const t=e.getContext("webgl");return t?(t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.BLEND),t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t):null}createShader(e,t){if(!this.gl)return;const s=this.gl.createShader(e);s&&this.shaderProgram&&(this.gl.shaderSource(s,t),this.gl.compileShader(s),this.gl.attachShader(this.shaderProgram,s))}initShaders(){if(!this.gl||(this.shaderProgram=this.gl.createProgram(),!this.shaderProgram))return;this.createShader(this.gl.FRAGMENT_SHADER,at),this.createShader(this.gl.VERTEX_SHADER,lt),this.gl.linkProgram(this.shaderProgram),this.gl.useProgram(this.shaderProgram);const e=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition");this.gl.enableVertexAttribArray(e),oe.set(this.shaderProgram,e);const t=this.gl.getAttribLocation(this.shaderProgram,"aVertexColor");this.gl.enableVertexAttribArray(t),ae.set(this.shaderProgram,t);const s=this.gl.getAttribLocation(this.shaderProgram,"aTextureCoord");this.gl.enableVertexAttribArray(s),le.set(this.shaderProgram,s);const i=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix");he.set(this.shaderProgram,i);const n=this.gl.getUniformLocation(this.shaderProgram,"uSampler");ce.set(this.shaderProgram,n)}resizeCanvas(){this.canvasElement.width=this.canvasElement.offsetWidth*window.devicePixelRatio,this.canvasElement.height=this.canvasElement.offsetHeight*window.devicePixelRatio}updateTransformAndConstraints(){const t=this.dimensionsForAutoscale||{width:0,height:0},s=this.layerTree?this.layerTree.viewportSize():null,i=s?s.width:t.width,n=s?s.height:t.height,r=this.canvasElement.width,o=this.canvasElement.height,l=r*.1,a=o*.1,h=(r-2*l)/i,p=(o-2*a)/n,g=Math.min(h,p),m=Math.min(i/t.width,n/t.width)/2;this.transformController.setScaleConstraints(m,10/g);const u=this.transformController.scale(),y=this.transformController.rotateX(),R=this.transformController.rotateY();this.scale=u*g;const C=I(this.scale,.1,1);C!==this.oldTextureScale&&(this.oldTextureScale=C,this.textureManager.setScale(C),this.dispatchEventToListeners("ScaleChanged",C));const S=new WebKitCSSMatrix().scale(u,u,u).translate(r/2,o/2,0).rotate(y,R,0).scale(g,g,g).translate(-i/2,-n/2,0);let b;for(let B=0;B<this.rects.length;++B)b=Xe(S,this.rects[B].vertices,b);b&&this.transformController.clampOffsets((l-b.maxX)/window.devicePixelRatio,(r-l-b.minX)/window.devicePixelRatio,(a-b.maxY)/window.devicePixelRatio,(o-a-b.minY)/window.devicePixelRatio);const be=this.transformController.offsetX()*window.devicePixelRatio,Pe=this.transformController.offsetY()*window.devicePixelRatio;this.projectionMatrix=new WebKitCSSMatrix().translate(be,Pe,0).multiply(S);const Le=new WebKitCSSMatrix().scale(1,-1,-1).translate(-1,-1,0).scale(2/this.canvasElement.width,2/this.canvasElement.height,1/1e6).multiply(this.projectionMatrix);if(this.shaderProgram){const B=he.get(this.shaderProgram);this.gl&&B&&this.gl.uniformMatrix4fv(B,!1,this.arrayFromMatrix(Le))}}arrayFromMatrix(e){return new Float32Array([e.m11,e.m12,e.m13,e.m14,e.m21,e.m22,e.m23,e.m24,e.m31,e.m32,e.m33,e.m34,e.m41,e.m42,e.m43,e.m44])}initWhiteTexture(){if(!this.gl)return;this.whiteTexture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.whiteTexture);const e=new Uint8Array([255,255,255,255]);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e)}initChromeTextures(){function e(t,s){q(s).then(i=>{this.chromeTextures[t]=i&&X.createTextureForImage(this.gl||null,i)||void 0})}e.call(this,0,"Images/chromeLeft.avif"),e.call(this,1,"Images/chromeMiddle.avif"),e.call(this,2,"Images/chromeRight.avif")}initGLIfNecessary(){return this.gl?this.gl:(this.gl=this.initGL(this.canvasElement),this.gl?(this.initShaders(),this.initWhiteTexture(),this.initChromeTextures(),this.textureManager.setContext(this.gl),this.gl):null)}calculateDepthsAndVisibility(){this.depthByLayerId=new Map;let e=0;const t=this.layerViewHost.showInternalLayersSetting().get();if(!this.layerTree)return;const s=t?this.layerTree.root():this.layerTree.contentRoot()||this.layerTree.root();if(!s)return;const i=[s];for(this.depthByLayerId.set(s.id(),0),this.visibleLayers=new Set;i.length>0;){const n=i.shift();if(!n)break;(t||n.drawsContent())&&this.visibleLayers.add(n);const r=n.children();for(let o=0;o<r.length;++o)this.depthByLayerId.set(r[o].id(),++e),i.push(r[o])}this.maxDepth=e}depthForLayer(e){return(this.depthByLayerId.get(e.id())||0)*ue}calculateScrollRectDepth(e,t){return this.depthForLayer(e)+t*yt+1}updateDimensionsForAutoscale(e){this.dimensionsForAutoscale||(this.dimensionsForAutoscale={width:0,height:0}),this.dimensionsForAutoscale.width=Math.max(e.width(),this.dimensionsForAutoscale.width),this.dimensionsForAutoscale.height=Math.max(e.height(),this.dimensionsForAutoscale.height)}calculateLayerRect(e){if(!this.visibleLayers.has(e))return;const t=new K(e),s=new O(t);s.setVertices(e.quad(),this.depthForLayer(e)),this.appendRect(s),this.updateDimensionsForAutoscale(e)}appendRect(e){const t=e.relatedObject,s=E.isEqual(this.lastSelection[T.Selected],t),i=E.isEqual(this.lastSelection[T.Hovered],t);if(s)e.borderColor=ct;else if(i){e.borderColor=ht;const n=e.fillColor||[255,255,255,1],r=mt;e.fillColor=[n[0]*r[0]/255,n[1]*r[1]/255,n[2]*r[2]/255,n[3]*r[3]]}else e.borderColor=dt;e.lineWidth=s?ft:gt,this.rects.push(e)}calculateLayerScrollRects(e){const t=e.scrollRects();for(let s=0;s<t.length;++s){const i=new we(e,s),n=new O(i);n.calculateVerticesFromRect(e,t[s].rect,this.calculateScrollRectDepth(e,s)),n.fillColor=pt,this.appendRect(n)}}calculateLayerTileRects(e){const t=this.textureManager.tilesForLayer(e);for(let s=0;s<t.length;++s){const i=t[s];if(!i.texture)continue;const n=new st(e,{rect:i.rect,snapshot:i.snapshot}),r=new O(n);this.snapshotLayers.has(e)||this.snapshotLayers.set(e,n),r.calculateVerticesFromRect(e,i.rect,this.depthForLayer(e)+1),r.texture=i.texture,this.appendRect(r)}}calculateRects(){if(this.rects=[],this.snapshotLayers.clear(),this.dimensionsForAutoscale={width:0,height:0},this.layerTree&&this.layerTree.forEachLayer(this.calculateLayerRect.bind(this)),this.showSlowScrollRectsSetting&&this.showSlowScrollRectsSetting.get()&&this.layerTree&&this.layerTree.forEachLayer(this.calculateLayerScrollRects.bind(this)),this.layerTexture&&this.visibleLayers.has(this.layerTexture.layer)){const e=this.layerTexture.layer,t=new K(e),s=new O(t);s.setVertices(e.quad(),this.depthForLayer(e)),s.texture=this.layerTexture.texture,this.appendRect(s)}else this.showPaints()&&this.layerTree&&this.layerTree.forEachLayer(this.calculateLayerTileRects.bind(this))}makeColorsArray(e){let t=[];const s=[e[0]/255,e[1]/255,e[2]/255,e[3]];for(let i=0;i<4;i++)t=t.concat(s);return t}setVertexAttribute(e,t,s){const i=this.gl;if(!i)return;const n=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW),i.vertexAttribPointer(e,s,i.FLOAT,!1,0,0)}drawRectangle(e,t,s,i){const n=this.gl;if(s=s||[255,255,255,1],!this.shaderProgram)return;const o=oe.get(this.shaderProgram),l=le.get(this.shaderProgram),a=ae.get(this.shaderProgram);if(typeof o<"u"&&this.setVertexAttribute(o,e,3),typeof l<"u"&&this.setVertexAttribute(l,[0,1,1,1,1,0,0,0],2),typeof a<"u"&&this.setVertexAttribute(a,this.makeColorsArray(s),s.length),!n)return;const h=ce.get(this.shaderProgram);i?h&&(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,i),n.uniform1i(h,0)):this.whiteTexture&&n.bindTexture(n.TEXTURE_2D,this.whiteTexture);const p=e.length/3;n.drawArrays(t,0,p)}drawTexture(e,t,s){this.gl&&this.drawRectangle(e,this.gl.TRIANGLE_FAN,s,t)}drawViewportAndChrome(){if(!this.layerTree)return;const e=this.layerTree.viewportSize();if(!e)return;const t=!W.instance().moduleSetting("frame-viewer-hide-chrome-window").get()&&this.chromeTextures.length>=3&&this.chromeTextures.indexOf(void 0)<0,s=(this.maxDepth+1)*ue,i=Math.ceil(de*this.scale);let n=[e.width,0,s,e.width,e.height,s,0,e.height,s,0,0,s];if(!this.gl||(this.gl.lineWidth(i),this.drawRectangle(n,t?this.gl.LINE_STRIP:this.gl.LINE_LOOP,ut),!t))return;const r=this.layerTree.viewportSize();if(!r)return;const o=de/2,l=r.width+2*o;if(this.chromeTextures[0]&&this.chromeTextures[2]){const a=N.get(this.chromeTextures[0])||{naturalHeight:0,naturalWidth:0},h=a.naturalHeight,p=N.get(this.chromeTextures[2])||{naturalHeight:0,naturalWidth:0},g=l-a.naturalWidth-p.naturalWidth;let m=-o;const u=-h;for(let y=0;y<this.chromeTextures.length;++y){const R=this.chromeTextures[y];if(!R)continue;const C=N.get(R);if(!C)continue;const S=y===1?g:C.naturalWidth;if(S<0||m+S>l)break;n=[m,u,s,m+S,u,s,m+S,u+h,s,m,u+h,s],this.drawTexture(n,this.chromeTextures[y]),m+=S}}}drawViewRect(e){if(!this.gl)return;const t=e.vertices;e.texture?this.drawTexture(t,e.texture,e.fillColor||void 0):e.fillColor&&this.drawRectangle(t,this.gl.TRIANGLE_FAN,e.fillColor),this.gl.lineWidth(e.lineWidth),e.borderColor&&this.drawRectangle(t,this.gl.LINE_LOOP,e.borderColor)}update(){if(!this.isShowing()){this.needsUpdate=!0;return}this.updateScheduled||(this.updateScheduled=!0,requestAnimationFrame(()=>requestAnimationFrame(()=>{this.updateScheduled=!1,this.innerUpdate()})))}innerUpdate(){if(!this.layerTree||!this.layerTree.root()){this.failBanner.show(this.contentElement);return}const e=this.initGLIfNecessary();if(!e){this.failBanner.element.removeChildren(),this.failBanner.element.appendChild(this.webglDisabledBanner()),this.failBanner.show(this.contentElement);return}this.failBanner.detach();const t=this.canvasElement.width,s=this.canvasElement.height;this.calculateDepthsAndVisibility(),this.calculateRects(),this.updateTransformAndConstraints(),e.viewport(0,0,t,s),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.rects.forEach(this.drawViewRect.bind(this)),this.drawViewportAndChrome()}webglDisabledBanner(){const e=this.contentElement.ownerDocument.createDocumentFragment();return e.createChild("div").textContent=v(w.cantDisplayLayers),e.createChild("div").textContent=v(w.webglSupportIsDisabledInYour),e.appendChild(Ue(ve,w.checkSForPossibleReasons,{PH1:je.create("about:gpu",void 0,void 0,void 0,"about-gpu")})),e}selectionFromEventPoint(e){const t=e;if(!this.layerTree)return null;let s=1/0,i=null;const n=new WebKitCSSMatrix().scale(1,-1,-1).translate(-1,-1,0).multiply(this.projectionMatrix),r=(t.clientX-this.canvasElement.getBoundingClientRect().left)*window.devicePixelRatio,o=-(t.clientY-this.canvasElement.getBoundingClientRect().top)*window.devicePixelRatio;function l(a){if(!a.relatedObject)return;const h=a.intersectWithLine(n,r,o);h&&h<s&&(s=h,i=a.relatedObject)}return this.rects.forEach(l),i}createVisibilitySetting(e,t,s,i){const n=W.instance().createSetting(t,s);return n.setTitle(e),n.addChangeListener(this.update,this),i.appendToolbarItem(new Ye(n)),n}initToolbar(){this.panelToolbar=this.transformController.toolbar(),this.contentElement.appendChild(this.panelToolbar.element),this.showPaintsSetting=this.createVisibilitySetting(v(w.paints),"frame-viewer-show-paints",!1,this.panelToolbar),this.showSlowScrollRectsSetting=this.createVisibilitySetting(v(w.slowScrollRects),"frame-viewer-show-slow-scroll-rects",!0,this.panelToolbar),this.showPaintsSetting.addChangeListener(this.updatePaints,this),W.instance().moduleSetting("frame-viewer-hide-chrome-window").addChangeListener(this.update,this)}onContextMenu(e){const t=new ge(e);t.defaultSection().appendItem(v(w.resetView),()=>this.transformController.resetAndNotify(),{jslogContext:"layers.3d-center"});const s=this.selectionFromEventPoint(e);s&&s.type()==="Snapshot"&&t.defaultSection().appendItem(v(w.showPaintProfiler),()=>this.dispatchEventToListeners("PaintProfilerRequested",s),{jslogContext:"layers.paint-profiler"}),this.layerViewHost.showContextMenu(t,s)}onMouseMove(e){e.which||this.layerViewHost.hoverObject(this.selectionFromEventPoint(e))}onMouseDown(e){const t=e;this.mouseDownX=t.clientX,this.mouseDownY=t.clientY}onMouseUp(e){const t=e,s=6;this.mouseDownX&&Math.abs(t.clientX-this.mouseDownX)<s&&Math.abs(t.clientY-(this.mouseDownY||0))<s&&(this.canvasElement.focus(),this.layerViewHost.selectObject(this.selectionFromEventPoint(e))),delete this.mouseDownX,delete this.mouseDownY}onDoubleClick(e){const t=this.selectionFromEventPoint(e);t&&(t.type()==="Snapshot"||t.layer())&&this.dispatchEventToListeners("PaintProfilerRequested",t),e.stopPropagation()}updatePaints(){this.showPaints()?(this.textureManager.setLayerTree(this.layerTree),this.textureManager.forceUpdate()):this.textureManager.reset(),this.update()}showPaints(){return this.showPaintsSetting?this.showPaintsSetting.get():!1}}var T;(function(d){d.Hovered="hovered",d.Selected="selected"})(T||(T={}));const at=`precision mediump float;
varying vec4 vColor;
varying vec2 vTextureCoord;
uniform sampler2D uSampler;
void main(void)
{
    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t)) * vColor;
}`,lt=`attribute vec3 aVertexPosition;
attribute vec2 aTextureCoord;
attribute vec4 aVertexColor;
uniform mat4 uPMatrix;
varying vec2 vTextureCoord;
varying vec4 vColor;
void main(void)
{
gl_Position = uPMatrix * vec4(aVertexPosition, 1.0);
vColor = aVertexColor;
vTextureCoord = aTextureCoord;
}`,ht=[0,0,255,1],ct=[0,255,0,1],dt=[0,0,0,1],ut=[160,160,160,1],pt=[178,100,100,.6],mt=[200,200,255,1],gt=1,ft=2,de=3,ue=20,yt=4;class X{textureUpdatedCallback;throttler;scale;active;queue;tilesByLayer;gl;constructor(e){this.textureUpdatedCallback=e,this.throttler=new _e(0),this.scale=0,this.active=!1,this.reset()}static createTextureForImage(e,t){if(!e)throw new Error("WebGLRenderingContext not provided");const s=e.createTexture();if(!s)throw new Error("Unable to create texture");return N.set(s,t),e.bindTexture(e.TEXTURE_2D,s),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),s}reset(){this.tilesByLayer&&this.setLayerTree(null),this.tilesByLayer=new Map,this.queue=[]}setContext(e){this.gl=e,this.scale&&this.updateTextures()}suspend(){this.active=!1}resume(){this.active=!0,this.queue.length&&this.update()}setLayerTree(e){const t=new Set,s=Array.from(this.tilesByLayer.keys());e&&e.forEachLayer(i=>{i.drawsContent()&&(t.add(i),this.tilesByLayer.has(i)||(this.tilesByLayer.set(i,[]),this.layerNeedsUpdate(i)))}),s.length||this.forceUpdate();for(const i of s){if(t.has(i))continue;const n=this.tilesByLayer.get(i);n&&n.forEach(r=>r.dispose()),this.tilesByLayer.delete(i)}}setSnapshotsForLayer(e,t){const s=new Map((this.tilesByLayer.get(e)||[]).map(o=>[o.snapshot,o])),i=[],n=[];for(const o of t){const l=s.get(o.snapshot);l?(n.push(l),s.delete(o.snapshot)):i.push(new wt(o))}this.tilesByLayer.set(e,n.concat(i));for(const o of s.values())o.dispose();const r=this.gl;return!r||!this.scale?Promise.resolve():Promise.all(i.map(o=>o.update(r,this.scale))).then(this.textureUpdatedCallback)}setScale(e){this.scale&&this.scale>=e||(this.scale=e,this.updateTextures())}tilesForLayer(e){return this.tilesByLayer.get(e)||[]}layerNeedsUpdate(e){this.queue.indexOf(e)<0&&this.queue.push(e),this.active&&this.throttler.schedule(this.update.bind(this))}forceUpdate(){this.queue.forEach(e=>this.updateLayer(e)),this.queue=[],this.update()}update(){const e=this.queue.shift();return e?(this.queue.length&&this.throttler.schedule(this.update.bind(this)),this.updateLayer(e)):Promise.resolve()}updateLayer(e){return Promise.all(e.snapshots()).then(t=>this.setSnapshotsForLayer(e,t.filter(s=>s!==null)))}updateTextures(){if(this.gl&&this.scale)for(const e of this.tilesByLayer.values())for(const t of e){const s=t.updateScale(this.gl,this.scale);s&&s.then(this.textureUpdatedCallback)}}}class O{relatedObject;lineWidth;borderColor;fillColor;texture;vertices;constructor(e){this.relatedObject=e,this.lineWidth=1,this.borderColor=null,this.fillColor=null,this.texture=null}setVertices(e,t){this.vertices=[e[0],e[1],t,e[2],e[3],t,e[4],e[5],t,e[6],e[7],t]}calculatePointOnQuad(e,t,s){const i=e[0],n=e[1],r=e[2],o=e[3],l=e[4],a=e[5],h=e[6],p=e[7],g=i+t*(r-i),m=n+t*(o-n),u=h+t*(l-h),y=p+t*(a-p),R=g+s*(u-g),C=m+s*(y-m);return[R,C]}calculateVerticesFromRect(e,t,s){const i=e.quad(),n=t.x/e.width(),r=(t.x+t.width)/e.width(),o=t.y/e.height(),l=(t.y+t.height)/e.height(),a=this.calculatePointOnQuad(i,n,o).concat(this.calculatePointOnQuad(i,r,o)).concat(this.calculatePointOnQuad(i,r,l)).concat(this.calculatePointOnQuad(i,n,l));this.setVertices(a,s)}intersectWithLine(e,t,s){let i;const n=[];for(i=0;i<4;++i)n[i]=ze(new ie(this.vertices[i*3],this.vertices[i*3+1],this.vertices[i*3+2]),e);const r=ne(_(n[1],n[0]),_(n[2],n[1])),o=r.x,l=r.y,a=r.z,p=-(-(o*n[0].x+l*n[0].y+a*n[0].z)+o*t+l*s)/a,g=new ie(t,s,p),m=n.map(_.bind(null,g));for(i=0;i<m.length;++i)if($e(r,ne(m[i],m[(i+1)%m.length]))<0)return;return p}}class wt{snapshot;rect;scale;texture;gl;constructor(e){this.snapshot=e.snapshot,this.rect=e.rect,this.scale=0,this.texture=null}dispose(){this.snapshot.release(),this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}updateScale(e,t){return this.texture&&this.scale>=t?null:this.update(e,t)}async update(e,t){this.gl=e,this.scale=t;const s=await this.snapshot.replay(t),i=s?await q(s):null;this.texture=i?X.createTextureForImage(e,i):null}}const xe=new CSSStyleSheet;xe.replaceSync(`/*
 * Copyright 2016 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file.
 */

.paint-profiler-overview {
  background-color: var(--sys-color-cdt-base-container);
}

.paint-profiler-canvas-container {
  flex: auto;
  position: relative;
}

.paint-profiler-pie-chart {
  width: 60px !important; /* stylelint-disable-line declaration-no-important */
  height: 60px !important; /* stylelint-disable-line declaration-no-important */
  padding: 2px;
  overflow: hidden;
  font-size: 10px;
}

.paint-profiler-canvas-container canvas {
  z-index: 200;
  background-color: var(--sys-color-cdt-base-container);
  opacity: 95%;
  height: 100%;
  width: 100%;
}

.paint-profiler-canvas-container .overview-grid-window-resizer {
  z-index: 2000;
}

/*# sourceURL=paintProfiler.css */
`);const x={profiling:"Profiling…",shapes:"Shapes",bitmap:"Bitmap",text:"Text",misc:"Misc",profilingResults:"Profiling results",commandLog:"Command Log"},Ct=H("panels/layer_viewer/PaintProfilerView.ts",x),P=A.bind(void 0,Ct);let $=null,G=null;class L extends Y(Ge){canvasContainer;progressBanner;pieChart;showImageCallback;canvas;context;selectionWindowInternal;innerBarWidth;minBarHeight;barPaddingWidth;outerBarWidth;pendingScale;scale;samplesPerBar;log;snapshot;logCategories;profiles;updateImageTimer;constructor(e){super(!0),this.contentElement.classList.add("paint-profiler-overview"),this.canvasContainer=this.contentElement.createChild("div","paint-profiler-canvas-container"),this.progressBanner=this.contentElement.createChild("div","full-widget-dimmed-banner hidden"),this.progressBanner.textContent=P(x.profiling),this.pieChart=new Ze,this.populatePieChart(0,[]),this.pieChart.classList.add("paint-profiler-pie-chart"),this.contentElement.appendChild(this.pieChart),this.showImageCallback=e,this.canvas=this.canvasContainer.createChild("canvas","fill"),this.context=this.canvas.getContext("2d"),this.selectionWindowInternal=new Je(this.canvasContainer),this.selectionWindowInternal.addEventListener("WindowChanged",this.onWindowChanged,this),this.innerBarWidth=4*window.devicePixelRatio,this.minBarHeight=window.devicePixelRatio,this.barPaddingWidth=2*window.devicePixelRatio,this.outerBarWidth=this.innerBarWidth+this.barPaddingWidth,this.pendingScale=1,this.scale=this.pendingScale,this.samplesPerBar=0,this.log=[],this.reset()}static categories(){return $||($={shapes:new F("shapes",P(x.shapes),"rgb(255, 161, 129)"),bitmap:new F("bitmap",P(x.bitmap),"rgb(136, 196, 255)"),text:new F("text",P(x.text),"rgb(180, 255, 137)"),misc:new F("misc",P(x.misc),"rgb(206, 160, 255)")}),$}static initLogItemCategories(){if(!G){const e=L.categories(),t={};t.Clear=e.misc,t.DrawPaint=e.misc,t.DrawData=e.misc,t.SetMatrix=e.misc,t.PushCull=e.misc,t.PopCull=e.misc,t.Translate=e.misc,t.Scale=e.misc,t.Concat=e.misc,t.Restore=e.misc,t.SaveLayer=e.misc,t.Save=e.misc,t.BeginCommentGroup=e.misc,t.AddComment=e.misc,t.EndCommentGroup=e.misc,t.ClipRect=e.misc,t.ClipRRect=e.misc,t.ClipPath=e.misc,t.ClipRegion=e.misc,t.DrawPoints=e.shapes,t.DrawRect=e.shapes,t.DrawOval=e.shapes,t.DrawRRect=e.shapes,t.DrawPath=e.shapes,t.DrawVertices=e.shapes,t.DrawDRRect=e.shapes,t.DrawBitmap=e.bitmap,t.DrawBitmapRectToRect=e.bitmap,t.DrawBitmapMatrix=e.bitmap,t.DrawBitmapNine=e.bitmap,t.DrawSprite=e.bitmap,t.DrawPicture=e.bitmap,t.DrawText=e.text,t.DrawPosText=e.text,t.DrawPosTextH=e.text,t.DrawTextOnPath=e.text,G=t}return G}static categoryForLogItem(e){const t=qe(e.method),s=L.initLogItemCategories();let i=s[t];return i||(i=L.categories().misc,s[t]=i),i}onResize(){this.update()}async setSnapshotAndLog(e,t,s){if(this.reset(),this.snapshot=e,this.snapshot&&this.snapshot.addReference(),this.log=t,this.logCategories=this.log.map(L.categoryForLogItem),!e){this.update(),this.populatePieChart(0,[]),this.selectionWindowInternal.setEnabled(!1);return}this.selectionWindowInternal.setEnabled(!0),this.progressBanner.classList.remove("hidden"),this.updateImage();const i=await e.profile(s);this.progressBanner.classList.add("hidden"),this.profiles=i,this.update(),this.updatePieChart()}setScale(e){const t=e>this.scale,s=2;this.pendingScale=Math.min(1,e*s),t&&this.snapshot&&this.updateImage()}update(){if(this.canvas.width=this.canvasContainer.clientWidth*window.devicePixelRatio,this.canvas.height=this.canvasContainer.clientHeight*window.devicePixelRatio,this.samplesPerBar=0,!this.profiles||!this.profiles.length||!this.logCategories)return;const e=Math.floor((this.canvas.width-2*this.barPaddingWidth)/this.outerBarWidth),t=this.log.length;this.samplesPerBar=Math.ceil(t/e);let s=0;const i=[],n=[];let r={};for(let a=0,h=0,p=0;a<t;){let g=this.logCategories[a]&&this.logCategories[a].name||"misc";const m=this.log[a].commandIndex;for(let u=0;u<this.profiles.length;u++){const y=this.profiles[u][m];p+=y,r[g]=(r[g]||0)+y}if(++a,a-h===this.samplesPerBar||a===t){const u=this.profiles.length*(a-h);p/=u;for(g in r)r[g]/=u;i.push(p),n.push(r),p>s&&(s=p),p=0,r={},h=a}}const o=4*window.devicePixelRatio,l=(this.canvas.height-o-this.minBarHeight)/s;for(let a=0;a<i.length;++a){for(const h in n[a])n[a][h]*=(i[a]*l+this.minBarHeight)/i[a];this.renderBar(a,n[a])}}renderBar(e,t){const s=L.categories();let i=0;const n=this.barPaddingWidth+e*this.outerBarWidth;for(const r in s){if(!t[r])continue;i+=t[r];const o=this.canvas.height-i;this.context.fillStyle=s[r].color,this.context.fillRect(n,o,this.innerBarWidth,t[r])}}onWindowChanged(){this.dispatchEventToListeners("WindowChanged"),this.updatePieChart(),!this.updateImageTimer&&(this.updateImageTimer=window.setTimeout(this.updateImage.bind(this),100))}updatePieChart(){const{total:e,slices:t}=this.calculatePieChart();this.populatePieChart(e,t)}calculatePieChart(){const e=this.selectionWindow();if(!this.profiles||!this.profiles.length||!e)return{total:0,slices:[]};let t=0;const s={};for(let n=e.left;n<e.right;++n){const r=this.log[n],o=L.categoryForLogItem(r);s[o.color]=s[o.color]||0;for(let l=0;l<this.profiles.length;++l){const a=this.profiles[l][r.commandIndex];t+=a,s[o.color]+=a}}const i=[];for(const n in s)i.push({value:s[n]/this.profiles.length,color:n,title:""});return{total:t/this.profiles.length,slices:i}}populatePieChart(e,t){this.pieChart.data={chartName:P(x.profilingResults),size:55,formatter:this.formatPieChartTime.bind(this),showLegend:!1,total:e,slices:t}}formatPieChartTime(e){return Ke(e*1e3,!0)}selectionWindow(){if(!this.log)return null;const e=(this.selectionWindowInternal.windowLeft||0)*this.canvas.width,t=(this.selectionWindowInternal.windowRight||0)*this.canvas.width,s=Math.floor(e/this.outerBarWidth),i=Math.floor((t+this.innerBarWidth-this.barPaddingWidth/2)/this.outerBarWidth),n=I(s*this.samplesPerBar,0,this.log.length-1),r=I(i*this.samplesPerBar,0,this.log.length);return{left:n,right:r}}updateImage(){delete this.updateImageTimer;let e,t;const s=this.selectionWindow();this.profiles&&this.profiles.length&&s&&(e=this.log[s.left].commandIndex,t=this.log[s.right-1].commandIndex);const i=this.pendingScale;this.snapshot&&this.snapshot.replay(i,e,t).then(n=>{n&&(this.scale=i,this.showImageCallback(n))})}reset(){this.snapshot&&this.snapshot.release(),this.snapshot=null,this.profiles=null,this.selectionWindowInternal.reset(),this.selectionWindowInternal.setEnabled(!1)}wasShown(){super.wasShown(),this.registerCSSFiles([xe])}}class Bt extends Qe{treeOutline;log;treeItemCache;selectionWindow;constructor(){super(),this.setMinimumSize(100,25),this.element.classList.add("overflow-auto"),this.treeOutline=new me,Z(this.treeOutline.contentElement,P(x.commandLog)),this.element.appendChild(this.treeOutline.element),this.setDefaultFocusedElement(this.treeOutline.contentElement),this.log=[],this.treeItemCache=new Map}setCommandLog(e){this.log=e,this.updateWindow({left:0,right:this.log.length})}appendLogItem(e){let t=this.treeItemCache.get(e);if(!t)t=new St(this,e),this.treeItemCache.set(e,t);else if(t.parent)return;this.treeOutline.appendChild(t)}updateWindow(e){this.selectionWindow=e,this.update()}doUpdate(){if(!this.selectionWindow||!this.log.length)return this.treeOutline.removeChildren(),Promise.resolve();const e=this.treeOutline.rootElement();for(;;){const t=e.firstChild();if(!t||t.logItem.commandIndex>=this.selectionWindow.left)break;e.removeChildAtIndex(0)}for(;;){const t=e.lastChild();if(!t||t.logItem.commandIndex<this.selectionWindow.right)break;e.removeChildAtIndex(e.children().length-1)}for(let t=this.selectionWindow.left,s=this.selectionWindow.right;t<s;++t)this.appendLogItem(this.log[t]);return Promise.resolve()}}class St extends J{logItem;ownerView;filled;constructor(e,t){super("",!!t.params),this.logItem=t,this.ownerView=e,this.filled=!1}onattach(){this.update()}async onpopulate(){for(const e in this.logItem.params)j.appendLogPropertyItem(this,e,this.logItem.params[e])}paramToString(e,t){if(typeof e!="object")return typeof e=="string"&&e.length>100?t:JSON.stringify(e);let s="",i=0;for(const n in e){const r=e[n];if(++i>4||r==="object"||r==="string"&&r.length>100)return t;s&&(s+=", "),s+=r}return s}paramsToString(e){let t="";for(const s in e)t&&(t+=", "),t+=this.paramToString(e[s],s);return t}update(){const e=document.createDocumentFragment();k(e,this.logItem.method+"("+this.paramsToString(this.logItem.params)+")"),this.title=e}}class j extends J{property;constructor(e){super(),this.property=e}static appendLogPropertyItem(e,t,s){const i=new j({name:t,value:s});if(e.appendChild(i),s&&typeof s=="object")for(const n in s)j.appendLogPropertyItem(i,n,s[n])}onattach(){const e=document.createDocumentFragment(),t=e.createChild("span","name");t.textContent=this.property.name;const s=e.createChild("span","separator");if(s.textContent=": ",this.property.value===null||typeof this.property.value!="object"){const i=e.createChild("span","value");i.textContent=JSON.stringify(this.property.value),i.classList.add("cm-js-"+(this.property.value===null?"null":typeof this.property.value))}this.title=e}}class F{name;title;color;constructor(e,t,s){this.name=e,this.title=t,this.color=s}}export{Lt as L,Bt as P,Pt as S,ot as T,L as a,Tt as b,Et as c,Rt as d,It as e};
//# sourceMappingURL=PaintProfilerView-caNlpRTi.js.map
