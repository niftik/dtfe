import{cd as m,bi as C,ce as T,cf as v,aR as I,aS as M,h as b,cg as p,ch as w,b as R,g as x,ci as B,i as D,cj as E,ck as k}from"./inspector-CyOA7R9n.js";import{P as A,a as W,L as _,S as q,b as F,c as O,d as N,e as H}from"./PaintProfilerView-caNlpRTi.js";import"./timelineOverviewInfo.css-BT4HnMd6.js";import"./PreviewFactory-7rWtg079.js";import"./DropTarget-DDkHhLsd.js";import"./ScriptFormatter-CdcZyJ9a.js";class L extends m{logTreeView;paintProfilerView;constructor(e){super(!0,!1),this.element.setAttribute("jslog",`${C("layers.paint-profiler").track({resize:!0})}`),this.logTreeView=new A,this.setSidebarWidget(this.logTreeView),this.paintProfilerView=new W(e),this.setMainWidget(this.paintProfilerView),this.paintProfilerView.addEventListener("WindowChanged",this.onWindowChanged,this),this.logTreeView.focus()}reset(){this.paintProfilerView.setSnapshotAndLog(null,[],null)}profile(e){e.commandLog().then(i=>t.call(this,e,i));function t(i,r){this.logTreeView.setCommandLog(r||[]),this.paintProfilerView.setSnapshotAndLog(i,r||[],null),i&&i.release()}}setScale(e){this.paintProfilerView.setScale(e)}onWindowChanged(){this.logTreeView.updateWindow(this.paintProfilerView.selectionWindow())}}const Z=Object.freeze(Object.defineProperty({__proto__:null,LayerPaintProfilerView:L},Symbol.toStringTag,{value:"Module"}));class u extends T{layerTreeAgent;paintProfilerModel;layerTreeInternal;throttler;enabled;lastPaintRectByLayerId;constructor(e){super(e),this.layerTreeAgent=e.layerTreeAgent(),e.registerLayerTreeDispatcher(new j(this)),this.paintProfilerModel=e.model(v);const t=e.model(I);t&&t.addEventListener(M.PrimaryPageChanged,this.onPrimaryPageChanged,this),this.layerTreeInternal=null,this.throttler=new b(20)}async disable(){this.enabled&&(this.enabled=!1,await this.layerTreeAgent.invoke_disable())}enable(){this.enabled||(this.enabled=!0,this.forceEnable())}async forceEnable(){this.lastPaintRectByLayerId=new Map,this.layerTreeInternal||(this.layerTreeInternal=new V(this)),await this.layerTreeAgent.invoke_enable()}layerTree(){return this.layerTreeInternal}async layerTreeChanged(e){this.enabled&&this.throttler.schedule(this.innerSetLayers.bind(this,e))}async innerSetLayers(e){const t=this.layerTreeInternal;await t.setLayers(e),this.lastPaintRectByLayerId||(this.lastPaintRectByLayerId=new Map);for(const i of this.lastPaintRectByLayerId.keys()){const r=this.lastPaintRectByLayerId.get(i),n=t.layerById(i);n&&n.setLastPaintRect(r)}this.lastPaintRectByLayerId=new Map,this.dispatchEventToListeners(s.LayerTreeChanged)}layerPainted(e,t){if(!this.enabled)return;const r=this.layerTreeInternal.layerById(e);if(!r){this.lastPaintRectByLayerId||(this.lastPaintRectByLayerId=new Map),this.lastPaintRectByLayerId.set(e,t);return}r.didPaint(t),this.dispatchEventToListeners(s.LayerPainted,r)}onPrimaryPageChanged(){this.layerTreeInternal=null,this.enabled&&this.forceEnable()}}T.register(u,{capabilities:2,autostart:!1});var s;(function(l){l.LayerTreeChanged="LayerTreeChanged",l.LayerPainted="LayerPainted"})(s||(s={}));class V extends _{layerTreeModel;constructor(e){super(e.target()),this.layerTreeModel=e}async setLayers(e){if(!e){this.innerSetLayers(e);return}const t=new Set;for(let i=0;i<e.length;++i){const r=e[i].backendNodeId;!r||this.backendNodeIdToNode().has(r)||t.add(r)}await this.resolveBackendNodeIds(t),this.innerSetLayers(e)}innerSetLayers(e){if(this.setRoot(null),this.setContentRoot(null),!e)return;let t;const i=this.layersById;this.layersById=new Map;for(let r=0;r<e.length;++r){const n=e[r].layerId;let a=i.get(n);a?a.reset(e[r]):a=new S(this.layerTreeModel,e[r]),this.layersById.set(n,a);const d=e[r].backendNodeId;d&&a.setNode(this.backendNodeIdToNode().get(d)||null),!this.contentRoot()&&a.drawsContent()&&this.setContentRoot(a);const h=a.parentId();if(h){const P=this.layersById.get(h);if(!P)throw new Error(`Missing parent ${h} for layer ${n}`);P.addChild(a)}else t&&console.assert(!1,"Multiple root layers"),t=a}t&&(this.setRoot(t),t.calculateQuad(new WebKitCSSMatrix))}}class S{scrollRectsInternal;quadInternal;childrenInternal;image;parentInternal;layerPayload;layerTreeModel;nodeInternal;lastPaintRectInternal;paintCountInternal;stickyPositionConstraintInternal;constructor(e,t){this.layerTreeModel=e,this.reset(t)}id(){return this.layerPayload.layerId}parentId(){return this.layerPayload.parentLayerId||null}parent(){return this.parentInternal}isRoot(){return!this.parentId()}children(){return this.childrenInternal}addChild(e){const t=e;t.parentInternal&&console.assert(!1,"Child already has a parent"),this.childrenInternal.push(t),t.parentInternal=this}setNode(e){this.nodeInternal=e}node(){return this.nodeInternal||null}nodeForSelfOrAncestor(){let e=this;for(;e;e=e.parentInternal)if(e.nodeInternal)return e.nodeInternal;return null}offsetX(){return this.layerPayload.offsetX}offsetY(){return this.layerPayload.offsetY}width(){return this.layerPayload.width}height(){return this.layerPayload.height}transform(){return this.layerPayload.transform||null}quad(){return this.quadInternal}anchorPoint(){return[this.layerPayload.anchorX||0,this.layerPayload.anchorY||0,this.layerPayload.anchorZ||0]}invisible(){return this.layerPayload.invisible||!1}paintCount(){return this.paintCountInternal||this.layerPayload.paintCount}lastPaintRect(){return this.lastPaintRectInternal||null}setLastPaintRect(e){this.lastPaintRectInternal=e}scrollRects(){return this.scrollRectsInternal}stickyPositionConstraint(){return this.stickyPositionConstraintInternal||null}async requestCompositingReasons(){return(await this.layerTreeModel.layerTreeAgent.invoke_compositingReasons({layerId:this.id()})).compositingReasons||[]}async requestCompositingReasonIds(){return(await this.layerTreeModel.layerTreeAgent.invoke_compositingReasons({layerId:this.id()})).compositingReasonIds||[]}drawsContent(){return this.layerPayload.drawsContent}gpuMemoryUsage(){return this.drawsContent()?this.width()*this.height()*4:0}snapshots(){return[this.layerTreeModel.paintProfilerModel.makeSnapshot(this.id()).then(t=>t?{rect:{x:0,y:0,width:this.width(),height:this.height()},snapshot:t}:null)]}didPaint(e){this.lastPaintRectInternal=e,this.paintCountInternal=this.paintCount()+1,this.image=null}reset(e){this.nodeInternal=null,this.childrenInternal=[],this.parentInternal=null,this.paintCountInternal=0,this.layerPayload=e,this.image=null,this.scrollRectsInternal=this.layerPayload.scrollRects||[],this.stickyPositionConstraintInternal=this.layerPayload.stickyPositionConstraint?new q(this.layerTreeModel.layerTree(),this.layerPayload.stickyPositionConstraint):null}matrixFromArray(e){function t(i){return i.toFixed(9)}return new WebKitCSSMatrix("matrix3d("+e.map(t).join(",")+")")}calculateTransformToViewport(e){let i=new WebKitCSSMatrix().translate(this.layerPayload.offsetX,this.layerPayload.offsetY);if(this.layerPayload.transform){const r=this.matrixFromArray(this.layerPayload.transform),n=new p(this.layerPayload.width*this.anchorPoint()[0],this.layerPayload.height*this.anchorPoint()[1],this.anchorPoint()[2]),a=w(n,i),d=new WebKitCSSMatrix().translate(-a.x,-a.y,-a.z);i=d.inverse().multiply(r.multiply(d.multiply(i)))}return i=e.multiply(i),i}createVertexArrayForRect(e,t){return[0,0,0,e,0,0,e,t,0,0,t,0]}calculateQuad(e){const t=this.calculateTransformToViewport(e);this.quadInternal=[];const i=this.createVertexArrayForRect(this.layerPayload.width,this.layerPayload.height);for(let n=0;n<4;++n){const a=w(new p(i[n*3],i[n*3+1],i[n*3+2]),t);this.quadInternal.push(a.x,a.y)}function r(n){n.calculateQuad(t)}this.childrenInternal.forEach(r)}}class j{layerTreeModel;constructor(e){this.layerTreeModel=e}layerTreeDidChange({layers:e}){this.layerTreeModel.layerTreeChanged(e||null)}layerPainted({layerId:e,clip:t}){this.layerTreeModel.layerPainted(e,t)}}const G=Object.freeze(Object.defineProperty({__proto__:null,AgentLayer:S,AgentLayerTree:V,get Events(){return s},LayerTreeModel:u},Symbol.toStringTag,{value:"Module"})),c={details:"Details",profiler:"Profiler"},$=R("panels/layers/LayersPanel.ts",c),g=x.bind(void 0,$);let y;class f extends B{model;layerViewHost;layerTreeOutline;rightSplitWidget;layers3DView;tabbedPane;layerDetailsView;paintProfilerView;updateThrottler;layerBeingProfiled;constructor(){super("layers",225),this.model=null,D.instance().observeTargets(this,{scoped:!0}),this.layerViewHost=new F,this.layerTreeOutline=new O(this.layerViewHost),this.layerTreeOutline.addEventListener("PaintProfilerRequested",this.onPaintProfileRequested,this),this.panelSidebarElement().appendChild(this.layerTreeOutline.element),this.setDefaultFocusedElement(this.layerTreeOutline.element),this.rightSplitWidget=new m(!1,!0,"layer-details-split-view-state"),this.splitWidget().setMainWidget(this.rightSplitWidget),this.layers3DView=new N(this.layerViewHost),this.rightSplitWidget.setMainWidget(this.layers3DView),this.layers3DView.addEventListener("PaintProfilerRequested",this.onPaintProfileRequested,this),this.layers3DView.addEventListener("ScaleChanged",this.onScaleChanged,this),this.tabbedPane=new E,this.rightSplitWidget.setSidebarWidget(this.tabbedPane),this.layerDetailsView=new H(this.layerViewHost),this.layerDetailsView.addEventListener("PaintProfilerRequested",this.onPaintProfileRequested,this),this.tabbedPane.appendTab(o.Details,g(c.details),this.layerDetailsView),this.paintProfilerView=new L(this.showImage.bind(this)),this.tabbedPane.addEventListener(k.TabClosed,this.onTabClosed,this),this.updateThrottler=new b(100)}static instance(e){return(!y||e?.forceNew)&&(y=new f),y}focus(){this.layerTreeOutline.focus()}wasShown(){super.wasShown(),this.model&&this.model.enable()}willHide(){this.model&&this.model.disable(),super.willHide()}targetAdded(e){e===e.outermostTarget()&&(this.model=e.model(u),this.model&&(this.model.addEventListener(s.LayerTreeChanged,this.onLayerTreeUpdated,this),this.model.addEventListener(s.LayerPainted,this.onLayerPainted,this),this.isShowing()&&(this.model.enable(),this.update())))}targetRemoved(e){!this.model||this.model.target()!==e||(this.model.removeEventListener(s.LayerTreeChanged,this.onLayerTreeUpdated,this),this.model.removeEventListener(s.LayerPainted,this.onLayerPainted,this),this.model.disable(),this.model=null)}onLayerTreeUpdated(){this.updateThrottler.schedule(this.update.bind(this))}update(){if(this.model){this.layerViewHost.setLayerTree(this.model.layerTree());const e=this.model.target().model(I);if(e){const t=e.mainFrame;if(t){const i=t.url;this.element.setAttribute("test-current-url",i)}}}return Promise.resolve()}onLayerPainted({data:e}){if(!this.model)return;const t=this.layerViewHost.selection();t&&t.layer()===e&&this.layerDetailsView.update(),this.layers3DView.updateLayerSnapshot(e)}onPaintProfileRequested({data:e}){this.layers3DView.snapshotForSelection(e).then(t=>{t&&(this.layerBeingProfiled=e.layer(),this.tabbedPane.hasTab(o.Profiler)||this.tabbedPane.appendTab(o.Profiler,g(c.profiler),this.paintProfilerView,void 0,!0,!0),this.tabbedPane.selectTab(o.Profiler),this.paintProfilerView.profile(t.snapshot))})}onTabClosed(e){e.data.tabId!==o.Profiler||!this.layerBeingProfiled||(this.paintProfilerView.reset(),this.layers3DView.showImageForLayer(this.layerBeingProfiled,void 0),this.layerBeingProfiled=null)}showImage(e){this.layerBeingProfiled&&this.layers3DView.showImageForLayer(this.layerBeingProfiled,e)}onScaleChanged(e){this.paintProfilerView.setScale(e.data)}}const o={Details:"details",Profiler:"profiler"},J=Object.freeze(Object.defineProperty({__proto__:null,DetailsViewTabs:o,LayersPanel:f},Symbol.toStringTag,{value:"Module"}));export{Z as LayerPaintProfilerView,G as LayerTreeModel,J as LayersPanel};
//# sourceMappingURL=layers-CMHbe2s5.js.map
